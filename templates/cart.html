<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}?cache_id={{ cache_id }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.product').forEach(function (product) {
                var cartButton = product.querySelector('#cartButton');
                cartButton.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const cart_id = product.querySelector('#cart_id').textContent.trim();
                    const response = await fetch('/remove_item/' + cart_id, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({}),
                    });
                    if (response.status === 200) {
                        const newButton = document.createElement('button');
                        newButton.id = 'addButton';
                        newButton.className = 'cart';
                        newButton.textContent = 'Add to cart';
                        const item = product.querySelector('#item').textContent.trim();
                        const price = product.querySelector('#price').textContent.trim();
                        const image_path = product.querySelector('#image').src.trim();
                        const image_p = new URL(image_path).pathname
                        const image = image_p.split('/static/')[1];
                        newButton.setAttribute('onclick', `add_to_db('${item}', '${price}', '${image}')`);
                        var parent = cartButton.parentNode;
                        parent.replaceChild(newButton, cartButton);
                        location.reload()
                    }
                });
            });
        });

        async function add_to_db(item, price, image) {
            const response = await fetch('/add_to_cart', {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item: item, price: price, image: image }),
            });
            if (response.ok) {
                location.reload(); // Optionally, you can reload the page or update the UI accordingly
            }
        }
    </script>
</head>
<body>
    <h3>Subtotal: {{ total_price }}</h3>
    <div class="content">
        {% for cart in carts %}
        <div class="product">
            <img src="{{ url_for('static', filename=cart.image) }}" alt="{{ cart.item }}" id="image">
            <h2 class="item" id="item">{{ cart.item }}</h2>
            <h6 class="price" id="price">{{ cart.price }}</h6>
            <p id="cart_id" style="display: none;">{{ cart.id }}</p>
            <button id="cartButton" class="cart">Remove from cart</button>
        </div>
        {% endfor %}
    </div>
    <button id="checkout" style="float: right;margin-right: 100px;" action="/checkout">Checkout</button>
</body>
</html>
